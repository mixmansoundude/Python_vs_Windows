# yamllint disable rule:line-length rule:truthy rule:document-start
# workflow-lint: standalone guard for GitHub Actions/YAML syntax
# Add this file at: .github/workflows/workflow-lint.yml
# Make it a required check in branch protection.

name: Workflow Lint (actionlint)

on:
  push:
    branches: ["**"]
    # Restricted to push events to avoid duplicate runs with other workflows per operator request.

permissions:
  contents: read
  actions: write

jobs:
  lint-workflows:
    name: Lint GitHub workflows
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download actionlint (no external linters)
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/bin"
          curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash \
            | bash -s -- latest "$RUNNER_TEMP/bin"
          # Make it available both now (this step) and in later steps
          export PATH="$RUNNER_TEMP/bin:$PATH"
          echo "$RUNNER_TEMP/bin" >> "$GITHUB_PATH"
          actionlint -version

      - name: Run actionlint over all workflows
        id: alint
        continue-on-error: true
        env:
          # Avoid invoking shellcheck/pyflakes which require extra setup
          ACTIONLINT_OPTS: >-
            -color never
            -shellcheck=
            -pyflakes=
        run: |
          set -euo pipefail
          : > "$RUNNER_TEMP/actionlint.out"
          # Lint both .yml and .yaml under .github/workflows/
          actionlint $ACTIONLINT_OPTS --pattern ".github/workflows/**/*.yml" --pattern ".github/workflows/**/*.yaml" \
            | tee "$RUNNER_TEMP/actionlint.out"
          # actionlint exits non-zero on problems; allow continue-on-error to proceed

      - name: Summarize result & publish tiny public files
        id: summarize
        env:
          ACTIONLINT_CONCLUSION: ${{ steps.alint.conclusion }}
        run: |
          set -euo pipefail
          OUT="$RUNNER_TEMP/actionlint.out"
          export OUT
          mkdir -p tests
          SUMMARY_TXT="tests/~workflow-lint-summary.txt"
          NDJSON="tests/~workflow-lint.ndjson"

          if [ -s "$OUT" ]; then
            first="$(head -n 1 "$OUT")"
            FIRST="$first"
            export FIRST
            total="$(grep -c '' "$OUT" || true)"
            echo "first_line<<EOF" >> "$GITHUB_OUTPUT"
            echo "$first" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "count=$total" >> "$GITHUB_OUTPUT"

            # Job Summary (public)
            {
              echo "## actionlint: **errors found**"
              echo
              echo "**First problem**"
              echo
              echo '```text'
              echo "$first"
              echo '```'
              echo
              echo "- Total diagnostics: $total"
            } >> "$GITHUB_STEP_SUMMARY"

            # Pages-friendly text
            printf '%s\n' "$first" > "$SUMMARY_TXT"

            # Optional NDJSON single-line first error (for iterate to ingest if needed)
            # NOTE: python is used here to avoid the nested heredoc quoting that previously broke on CI.
            python3 - <<'PY' "$NDJSON"
            import json
            import os
            import sys

            ndjson_path = sys.argv[1]
            first = os.environ.get('FIRST')
            if not first:
                out_path = os.environ.get('OUT')
                if out_path:
                    with open(out_path, 'r', encoding='utf-8', errors='ignore') as handle:
                        first = handle.readline().rstrip('\n')
            first = first or ""
            record = {
                "id": "workflow.lint",
                "desc": first,
                "source": ".github/workflows",
            }
            with open(ndjson_path, 'w', encoding='utf-8') as handle:
                json.dump(record, handle, ensure_ascii=False)
                handle.write('\n')
            PY

          else
            if [ "${ACTIONLINT_CONCLUSION:-success}" != "success" ]; then
              echo "::error title=actionlint::actionlint execution failed (see logs above)"
              exit 1
            }
            echo "count=0" >> "$GITHUB_OUTPUT"
            {
              echo "## actionlint: no issues"
              echo
              echo "Scanned .github/workflows/**/*.yml and .yaml"
            } >> "$GITHUB_STEP_SUMMARY"
            printf 'actionlint: no issues\n' > "$SUMMARY_TXT"
            : > "$NDJSON"
          fi
        shell: bash

      - name: Fail if problems were found
        if: ${{ steps.summarize.outputs.count != '0' }}
        run: |
          echo "::error title=actionlint::Workflow YAML problems detected (see summary above)"
          exit 1

      # Optional: keep tiny files for other jobs (e.g., your Pages job)
      - name: Upload mini outputs (optional)
        uses: actions/upload-artifact@v4
        with:
          name: workflow-lint-mini
          path: |
            tests/~workflow-lint-summary.txt
            tests/~workflow-lint.ndjson
          if-no-files-found: warn
          retention-days: 7
