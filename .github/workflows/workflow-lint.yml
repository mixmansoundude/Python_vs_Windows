# yamllint disable rule:line-length rule:truthy rule:document-start
# workflow-lint: standalone guard for GitHub Actions/YAML syntax
# Add this file at: .github/workflows/workflow-lint.yml
# Make it a required check in branch protection.

name: Workflow Lint (actionlint)

on:
  push:
    branches: ["**"]
    # Restricted to push events to avoid duplicate runs with other workflows per operator request.

permissions:
  contents: read
  actions: write

jobs:
  lint-workflows:
    name: Lint GitHub workflows
    runs-on: ubuntu-latest
    timeout-minutes: 7
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List workflow files (for visibility)
        id: list
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP"
          ls_out="$RUNNER_TEMP/workflow-files.txt"
          # Find both .yml and .yaml under .github/workflows
          git ls-files '.github/workflows/*.yml' '.github/workflows/*.yaml' > "$ls_out" || true
          count="$(grep -c '' "$ls_out" || true)"
          echo "count=$count" >> "$GITHUB_OUTPUT"
          {
            echo "### Workflow Lint summary"
            echo
            if [ "$count" -gt 0 ]; then
              echo "_Discovered workflow files:_"
              echo
              echo '```text'
              head -n 200 "$ls_out"
              echo '```'
            else
              echo "_No workflow files found in .github/workflows_"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Download actionlint (no external linters)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/bin"
          curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash             | bash -s -- -b "$RUNNER_TEMP/bin"
          # Make it available both now and in later steps
          export PATH="$RUNNER_TEMP/bin:$PATH"
          echo "$RUNNER_TEMP/bin" >> "$GITHUB_PATH"
          actionlint -version

      - name: Run actionlint over all workflows
        id: alint
        continue-on-error: true
        shell: bash
        env:
          # Avoid invoking shellcheck/pyflakes which require extra setup
          ACTIONLINT_OPTS: >-
            -color never
            -shellcheck=
            -pyflakes=
        run: |
          set -euo pipefail
          : > "$RUNNER_TEMP/actionlint.out"
          # Let actionlint auto-discover workflows under .github/workflows/
          set +e
          actionlint $ACTIONLINT_OPTS 2>&1 | tee "$RUNNER_TEMP/actionlint.out"
          rc=$?
          set -e
          echo "exit_code=$rc" >> "$GITHUB_OUTPUT"

      - name: YAML syntax check (PyYAML)
        id: pyyaml
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --disable-pip-version-check --no-input --quiet pyyaml
          PY_TMP="$RUNNER_TEMP/pyyaml.out"
          : > "$PY_TMP"
          python3 - <<'PY'
import glob, sys, yaml
files = glob.glob(".github/workflows/**/*.yml", recursive=True) + glob.glob(".github/workflows/**/*.yaml", recursive=True)
bad = []
for f in sorted(files):
    try:
        with open(f, "rb") as fh:
            yaml.safe_load(fh)
    except Exception as e:
        msg = str(e).splitlines()[0]
        print(f"{f}: {msg}")
        bad.append(f)
sys.exit(1 if bad else 0)
PY
          rc=$?
          echo "exit_code=$rc" >> "$GITHUB_OUTPUT"

      - name: Summarize and fail if needed
        if: always()
        id: summarize
        shell: bash
        run: |
          set -euo pipefail
          AL_OUT="$RUNNER_TEMP/actionlint.out"
          al_rc="${{ steps.alint.outputs.exit_code || '0' }}"
          py_rc="${{ steps.pyyaml.outputs.exit_code || '0' }}"
          # First actionable line from actionlint, if any
          first_al="$( (grep -m1 -E '^[^:]+:[0-9]+:[0-9]+:' "$AL_OUT" || true) )"
          {
            echo "### actionlint result"
            echo "- exit_code: ${al_rc}"
            if [ -s "$AL_OUT" ]; then
              echo
              echo "**First diagnostic**"
              echo '```text'
              if [ -n "$first_al" ]; then echo "$first_al"; else head -n 1 "$AL_OUT"; fi
              echo '```'
            else
              echo
              echo "_No output from actionlint_"
            fi
            echo
            echo "### YAML parse check (PyYAML)"
            echo "- exit_code: ${py_rc}"
            if [ "${py_rc}" != "0" ]; then
              echo
              echo "**PyYAML detected a syntax error. See job log for details.**"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          # Produce tiny files for your Pages sweep (optional)
          mkdir -p tests
          SUMMARY_MD="tests/~workflow-lint-summary.md"
          NDJSON="tests/~workflow-lint.ndjson"
          if [ "${al_rc}" != "0" ] || [ "${py_rc}" != "0" ]; then
            if [ -s "$AL_OUT" ]; then
              FIRST_LINE="$(head -n 1 "$AL_OUT")"
            else
              FIRST_LINE="YAML parse error (see job log)"
            fi
            printf '%s
' "$FIRST_LINE" > "$SUMMARY_MD"
            python3 - <<'PY' "$NDJSON" "$FIRST_LINE"
import json, sys
path, first = sys.argv[1], sys.argv[2]
with open(path, "w", encoding="utf-8") as f:
    f.write(json.dumps({"id":"workflow.lint","desc":first,"source":".github/workflows"}))
    f.write("
")
PY
          else
            printf 'actionlint: no issues
' > "$SUMMARY_MD"
            : > "$NDJSON"
          fi

          # Final outcome
          if [ "${al_rc}" != "0" ] || [ "${py_rc}" != "0" ]; then
            echo "::error title=workflow-lint::Problems detected by actionlint or YAML parse check"
            exit 1
          fi

      - name: Upload mini outputs (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-lint-summary-${{ github.run_attempt }}
          path: |
            tests/~workflow-lint-summary.md
            tests/~workflow-lint.ndjson
          if-no-files-found: warn
          retention-days: 7
