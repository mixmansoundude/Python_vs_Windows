# yamllint disable rule:line-length rule:truthy rule:colons rule:document-start
# version: v2025-10-06.6 (Cookbook-lean)
# Purpose: Self-healing CI iterate job (lean, based on cookbook patterns)
# Major choices:
# - No status functions in expressions (avoid always()/cancelled()).
# - Prompt is a small file; Codex reads repo files (AGENTS.md, etc.) itself.
# - Use body-path for PR to avoid 21k expression limits.
# - Attempts limited to 20 via branch-scoped artifact state.
# Helpful URLs:
# - Expressions: https://docs.github.com/actions/learn-github-actions/expressions
# - Env files: https://docs.github.com/actions/using-workflows/workflow-commands-for-github-actions#environment-files
# - PR action: https://github.com/peter-evans/create-pull-request

name: Codex - Auto Iterate on CI Failure

on:
  workflow_run:
    workflows:
      - "Batch syntax/run check"
    types: [completed]
  workflow_dispatch: {}
  push:
    branches: ['**']

permissions:
  actions: read
  contents: write
  pull-requests: write

concurrency:
  group: codex-iterate-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

jobs:
  iterate:
    # Allow manual & push. For workflow_run, only when upstream wasn't success.
    if: ${{ github.event_name == 'workflow_dispatch'
            || github.event_name == 'push'
            || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      MAX_ATTEMPTS: '20'

    steps:
      - name: Debug event
        run: |
          echo "event=${{ github.event_name }}"
          echo "ref_name=${{ github.ref_name }}"
          echo "sha=${{ github.sha }}"
          echo "actor=${{ github.actor }}"

      - name: Checkout repo (latest)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gather context
        id: ctx
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            branch="${{ github.event.workflow_run.head_branch }}"
            sha="${{ github.event.workflow_run.head_sha }}"
            run_id="${{ github.event.workflow_run.id }}"
            conclusion="${{ github.event.workflow_run.conclusion }}"
          else
            branch="${{ github.ref_name }}"
            sha="${{ github.sha }}"
            run_id="${{ github.run_id }}"
            conclusion=""
          fi
          if [ -z "$branch" ]; then branch="${{ github.ref_name }}"; fi
          branch_slug=$(echo "$branch" | tr ':/ ' '---')
          run_url="https://github.com/${{ github.repository }}/actions/runs/${run_id}"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"
          echo "branch_slug=$branch_slug" >> "$GITHUB_OUTPUT"
          echo "head_sha=$sha" >> "$GITHUB_OUTPUT"
          echo "run_id=$run_id" >> "$GITHUB_OUTPUT"
          echo "run_url=$run_url" >> "$GITHUB_OUTPUT"
          echo "conclusion=$conclusion" >> "$GITHUB_OUTPUT"

      - name: "Optional: download upstream logs/artifacts"
        if: ${{ github.event_name == 'workflow_run' }}
        shell: bash
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          mkdir -p runlogs artifacts
          curl -sSL -H "Authorization: Bearer $GH_TOKEN"             -o runlogs.zip             "https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/logs"
          unzip -q runlogs.zip -d runlogs || true
          curl -sS -H "Authorization: Bearer $GH_TOKEN"             "https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/artifacts" > artifacts.json
          ids=$(jq -r '.artifacts[] | select(.expired==false) | .id' artifacts.json || true)
          for id in $ids; do
            curl -sSL -H "Authorization: Bearer $GH_TOKEN"               -L "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$id/zip"               -o "artifacts/$id.zip" || true
            unzip -q "artifacts/$id.zip" -d "artifacts/$id" || true
          done

      - name: Load/Update attempt counter
        id: attempts
        shell: bash
        run: |
          set -euo pipefail
          attempts=0
          # Try get previous from artifact named by branch slug
          GH_TOKEN="${{ github.token }}"
          owner_repo="${{ github.repository }}"
          branch_slug="${{ steps.ctx.outputs.branch_slug }}"
          curl -sS -H "Authorization: Bearer $GH_TOKEN"             "https://api.github.com/repos/${owner_repo}/actions/artifacts?per_page=100" > artifacts_all.json
          id=$(jq -r --arg n "iterate-state-$branch_slug" '.artifacts[] | select(.name==$n and .expired==false) | .id' artifacts_all.json | head -n 1 || true)
          if [ -n "$id" ] && [ "$id" != "null" ]; then
            curl -sSL -H "Authorization: Bearer $GH_TOKEN" -L               "https://api.github.com/repos/${owner_repo}/actions/artifacts/$id/zip"               -o state.zip || true
            mkdir -p state && unzip -q state.zip -d state || true
            attempts=$(jq -r '.attempts // 0' state/iterate_state.json 2>/dev/null || echo 0)
          fi
          next=$(( attempts + 1 ))
          if [ "$next" -gt "${MAX_ATTEMPTS}" ]; then
            echo "should_iterate=false" >> "$GITHUB_OUTPUT"
            echo "stop_reason=Max attempts reached (${MAX_ATTEMPTS})" >> "$GITHUB_OUTPUT"
            echo "previous=$attempts" >> "$GITHUB_OUTPUT"
            echo "next=$attempts" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "previous=$attempts" >> "$GITHUB_OUTPUT"
          echo "next=$next" >> "$GITHUB_OUTPUT"
          # Gate: Only iterate on workflow_run or manual; for push you can flip this if desired
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "should_iterate=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_iterate=false" >> "$GITHUB_OUTPUT"
            echo "stop_reason=manual/push run - dry gate" >> "$GITHUB_OUTPUT"
          fi

      - name: Build prompt
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        id: prompt
        shell: bash
        run: |
          set -euo pipefail
          PROMPT="$RUNNER_TEMP/prompt.txt"
          repo="${{ github.repository }}"
          branch="${{ steps.ctx.outputs.branch }}"
          sha="${{ steps.ctx.outputs.head_sha }}"
          run_url="${{ steps.ctx.outputs.run_url }}"
          attempt="${{ steps.attempts.outputs.next }}"
          {
            echo "You are Codex. You have a working copy of the repo checked out."
            echo "Read AGENTS.md (if present) and README.md in the workspace for local policy."
            echo ""
            echo "Task: diagnose and fix CI failures for the GitHub Actions workflow(s)."
            echo "Prefer minimal edits and explain changes in commit messages."
            echo ""
            echo "Repo: $repo"
            echo "Branch: $branch"
            echo "Commit: $sha"
            echo "Upstream run (that triggered this): $run_url"
            echo "Attempt: $attempt/${MAX_ATTEMPTS}"
            echo ""
            echo "Acceptance criteria:"
            echo "1) Primary CI workflow passes end-to-end on this branch."
            echo "2) No new warnings/errors introduced; keep diffs small and ASCII-safe."
            echo "3) Preserve Windows batch quoting/escaping and CRLF conventions if applicable."
            echo ""
            echo "Instructions:"
            echo "- Inspect recent workflow logs and any artifacts under ./artifacts and ./runlogs."
            echo "- Open and modify files to address the failure."
            echo "- Run any repo-provided self-tests/scripts to validate."
            echo "- Stage changes and commit with a descriptive message."
          } > "$PROMPT"
          echo "path=$PROMPT" >> "$GITHUB_OUTPUT"

      - name: Prompt preview
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        run: |
          {
            echo "### Prompt (first 120 lines)"
            echo '```text'
            head -n 120 "${{ steps.prompt.outputs.path }}"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Install Codex CLI
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        run: npm i -g @openai/codex@latest

      - name: Configure git author
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

      - name: Run Codex (stdin prompt)
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        id: codex
        timeout-minutes: 10
        continue-on-error: true
        env:
            OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -o pipefail
          codex -a never --sandbox workspace-write exec --model gpt-4o-mini < "${{ steps.prompt.outputs.path }}" 2>&1 | tee "$RUNNER_TEMP/codex_exec.log" || true

      - name: Detect changes
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        id: diffcheck
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build PR body file
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        id: pr_body
        shell: bash
        run: |
          set -euo pipefail
          BODY=".github/ITERATE_PR_BODY.md"
          mkdir -p .github
          {
            echo "## Codex iteration"
            echo
            echo "- Branch: \`${{ steps.ctx.outputs.branch }}\` @ ${{ steps.ctx.outputs.head_sha }}"
            echo "- Trigger: ${{ steps.ctx.outputs.run_url }}"
            echo
            echo "### Prompt (first 200 lines)"
            echo '```text'
            head -n 200 "${{ steps.prompt.outputs.path }}" || true
            echo '```'
            echo
            echo "### Codex log (last 200 lines)"
            echo '```text'
            tail -n 200 "$RUNNER_TEMP/codex_exec.log" 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g' || true
            echo '```'
          } > "$BODY"
          echo "body_path=$BODY" >> "$GITHUB_OUTPUT"

      - name: Create PR (if edits)
        if: ${{ steps.attempts.outputs.should_iterate == 'true' && steps.diffcheck.outputs.changed == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "codex: iterate on CI failure (attempt ${{ steps.attempts.outputs.next }}/${{ env.MAX_ATTEMPTS }})"
          branch: codex/ci-fix-${{ steps.ctx.outputs.branch_slug }}
          base: ${{ steps.ctx.outputs.branch }}
          title: "Codex: iterate on CI failure â€“ ${{ steps.ctx.outputs.branch }}"
          body-path: ${{ steps.pr_body.outputs.body_path }}
          labels: codex,ci-fix,automerge-candidate

      - name: Upload diagnostics
        if: ${{ true }}
        uses: actions/upload-artifact@v4
        with:
          name: iterate-diag-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            runlogs/**
            artifacts/**
            ${{ steps.prompt.outputs.path }}
            ${{ steps.pr_body.outputs.body_path }}
            $RUNNER_TEMP/codex_exec.log
          if-no-files-found: ignore
          retention-days: 14

      - name: Save attempt state
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        shell: bash
        run: |
          mkdir -p state_out
          cat > state_out/iterate_state.json <<'JSON'
          {
            "attempts": ${{ steps.attempts.outputs.next }},
            "run_id": "${{ steps.ctx.outputs.run_id }}",
            "head_sha": "${{ steps.ctx.outputs.head_sha }}"
          }
          JSON

      - name: Upload attempt state
        if: ${{ steps.attempts.outputs.should_iterate == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: iterate-state-${{ steps.ctx.outputs.branch_slug }}
          path: state_out
          if-no-files-found: ignore
          retention-days: 30
