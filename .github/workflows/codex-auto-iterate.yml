# yamllint disable rule:line-length rule:truthy rule:colons rule:document-start
name: Codex - Auto Iterate on CI Failure

on:
  workflow_run:
    workflows:
      - Batch syntax/run check
    types:
      - completed

permissions:
  contents: write
  actions: read
  pages: write

defaults:
  run:
    shell: bash

concurrency:
  group: codex-auto-${{ github.event.workflow_run.id }}-${{ github.run_attempt }}
  cancel-in-progress: true

jobs:
  iterate:
    name: Codex auto-iterate
    runs-on: ubuntu-latest
    timeout-minutes: 75
    environment:
      name: github-pages
    env:
      SOURCE_RUN_ID: ${{ github.event.workflow_run.id }}
      SOURCE_RUN_ATTEMPT: ${{ github.event.workflow_run.run_attempt }}
      SOURCE_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
      SOURCE_RUN_HTML: ${{ github.event.workflow_run.html_url }}
      SOURCE_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
      SOURCE_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
      REPO_SLUG: ${{ github.repository }}
      MAX_ATTEMPTS: '4'
    steps:
      - name: Summarize upstream status
        run: |
          {
            echo "### Iterate trigger"
            echo ""
            echo "- upstream run: ${SOURCE_RUN_HTML}"
            echo "- upstream conclusion: ${SOURCE_CONCLUSION}"
            echo "- upstream attempt: ${SOURCE_RUN_ATTEMPT}"
            echo "- head branch: ${SOURCE_HEAD_BRANCH:-'(none)'}"
            echo "- head sha: ${SOURCE_HEAD_SHA}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Nothing to do (upstream succeeded)
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        run: |
          {
            echo ""
            echo "- iteration skipped because upstream workflow completed successfully."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout failure branch
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.event.workflow_run.head_sha }}
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git identity
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Collect upstream artifacts manifest
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        id: artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${{ github.repository }}/actions/runs/${SOURCE_RUN_ID}/artifacts?per_page=100"
          meta="$RUNNER_TEMP/upstream_artifacts.json"
          curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "$api" -o "$meta"
          echo "path=$meta" >> "$GITHUB_OUTPUT"

      - name: Download upstream nudge artifacts
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          run-id: ${{ env.SOURCE_RUN_ID }}
          pattern: codex_nudge-*
          path: ${{ runner.temp }}/upstream_nudge
          merge-multiple: true

      - name: Download upstream diagnostics URLs
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          run-id: ${{ env.SOURCE_RUN_ID }}
          pattern: codex_nudge_url-*
          path: ${{ runner.temp }}/upstream_diag
          merge-multiple: true

      - name: Download upstream Pages artifact
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          run-id: ${{ env.SOURCE_RUN_ID }}
          name: pages-deploy-pages-${{ env.SOURCE_RUN_ID }}-${{ env.SOURCE_RUN_ATTEMPT }}
          path: ${{ runner.temp }}/pages-upstream

      - name: Check OpenAI API key
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        id: key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          present=false
          if [ -n "${OPENAI_API_KEY:-}" ]; then
            present=true
          fi
          echo "present=$present" >> "$GITHUB_OUTPUT"
          {
            echo "### OpenAI API key"
            echo "- present: $present"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Mini preflight (gpt-4o-mini)
        if: ${{ github.event.workflow_run.conclusion != 'success' && steps.key.outputs.present == 'true' }}
        id: preflight
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          body='{"model":"gpt-4o-mini","messages":[{"role":"user","content":"ping"}],"max_tokens":1}'
          resp="$RUNNER_TEMP/preflight.json"
          http=$(curl -sS -o "$resp" -w '%{http_code}' https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$body" || echo 000)
          echo "$http" > "$RUNNER_TEMP/preflight.status"
          head -c 1200 "$resp" > "$RUNNER_TEMP/preflight.body" || true
          ok=false
          if [ "$http" = "200" ]; then
            ok=true
            echo "mini-ok"
          fi
          echo "ok=$ok" >> "$GITHUB_OUTPUT"
          echo "http=$http" >> "$GITHUB_OUTPUT"
          {
            echo "### Preflight (gpt-4o-mini)"
            echo "- http: $http"
            echo "- ok: $ok"
          } >> "$GITHUB_STEP_SUMMARY"
          if [ "$ok" != "true" ]; then
            {
              echo ""
              echo "Preflight response (first 400 chars):"
              echo '```json'
              sed 's/[^[:print:]\t]/?/g' "$RUNNER_TEMP/preflight.body" | head -c 400
              echo
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Prepare iterate workspace
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        id: prep
        env:
          SOURCE_RUN_ID: ${{ env.SOURCE_RUN_ID }}
          SOURCE_RUN_ATTEMPT: ${{ env.SOURCE_RUN_ATTEMPT }}
          SOURCE_HEAD_SHA: ${{ env.SOURCE_HEAD_SHA }}
          META_PATH: ${{ steps.artifacts.outputs.path }}
          KEY_PRESENT: ${{ steps.key.outputs.present || 'false' }}
          PREFLIGHT_OK: ${{ steps.preflight.outputs.ok || 'false' }}
          REPO_SLUG: ${{ github.repository }}
        run: |
          set -euo pipefail
          attempt_dir="$RUNNER_TEMP/iterate/${SOURCE_RUN_ID}-${SOURCE_RUN_ATTEMPT}"
          mkdir -p "$attempt_dir"
          nudge_path="$attempt_dir/codex_nudge.txt"
          url_path="$attempt_dir/codex_nudge_url.txt"
          upstream_nudge_dir="$RUNNER_TEMP/upstream_nudge"
          if [ -d "$upstream_nudge_dir" ]; then
            found=$(find "$upstream_nudge_dir" -maxdepth 3 -type f -name 'codex_nudge.txt' | head -n1 || true)
            if [ -n "$found" ]; then
              cat "$found" > "$nudge_path"
            fi
          fi
          if [ ! -s "$nudge_path" ]; then
            printf '%s\n%s\n' \
              'CI failed. Summarize the failure and apply the smallest safe change set to make the Windows batch bootstrapper pass CI.' \
              'Respect existing logging, keep diagnostics minimal, and prefer surgical edits over refactors.' > "$nudge_path"
          fi
          {
            echo "Run: https://github.com/${REPO_SLUG}/actions/runs/${SOURCE_RUN_ID}"
            echo "Logs: https://github.com/${REPO_SLUG}/actions/runs/${SOURCE_RUN_ID}/logs"
            echo "Artifacts: https://github.com/${REPO_SLUG}/actions/runs/${SOURCE_RUN_ID}/artifacts"
            echo "Repo ZIP: https://github.com/${REPO_SLUG}/zipball/${SOURCE_HEAD_SHA}"
          } > "$url_path"
          upstream_diag_dir="$RUNNER_TEMP/upstream_diag"
          if [ -d "$upstream_diag_dir" ]; then
            diag_file=$(find "$upstream_diag_dir" -maxdepth 3 -type f -name 'codex_nudge_url.txt' | head -n1 || true)
            if [ -n "$diag_file" ]; then
              diag_url=$(cat "$diag_file")
              if [ -n "$diag_url" ]; then
                echo "Diagnostics: $diag_url" >> "$url_path"
              fi
            fi
          fi
          if [ -n "$META_PATH" ] && [ -f "$META_PATH" ]; then
            jq -r '.artifacts[] | select((.expired // false) == false) | "\(.name): \(.archive_download_url)"' "$META_PATH" > "$attempt_dir/artifacts.txt" || true
            if [ -s "$attempt_dir/artifacts.txt" ]; then
              {
                echo ""
                echo "Artifact download URLs:"
                cat "$attempt_dir/artifacts.txt"
              } >> "$url_path"
            fi
          fi
          log="$RUNNER_TEMP/codex_exec.log"
          if [ ! -f "$log" ]; then
            : > "$log"
          fi
          attempts_log="$RUNNER_TEMP/codex_attempts.txt"
          : > "$attempts_log"
          if [ "$KEY_PRESENT" != "true" ]; then
            echo "[iterate] skipped: OPENAI_API_KEY missing." >> "$log"
          elif [ "$PREFLIGHT_OK" != "true" ]; then
            echo "[iterate] skipped: preflight probe failed." >> "$log"
          else
            echo "[iterate] preflight ok; attempting automated fix." >> "$log"
          fi
          echo "dir=$attempt_dir" >> "$GITHUB_OUTPUT"
          echo "nudge=$nudge_path" >> "$GITHUB_OUTPUT"
          echo "urls=$url_path" >> "$GITHUB_OUTPUT"
          echo "attempts_log=$attempts_log" >> "$GITHUB_OUTPUT"

      - name: Run Codex attempts
        if: ${{ github.event.workflow_run.conclusion != 'success' && steps.key.outputs.present == 'true' && steps.preflight.outputs.ok == 'true' }}
        id: codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MAX_ATTEMPTS: ${{ env.MAX_ATTEMPTS }}
          NUDGE_PATH: ${{ steps.prep.outputs.nudge }}
          ATTEMPTS_LOG: ${{ steps.prep.outputs.attempts_log }}
        run: |
          set -euo pipefail
          log="$RUNNER_TEMP/codex_exec.log"
          touch "$log"
          prompt="$NUDGE_PATH"
          if [ -z "$prompt" ] || [ ! -f "$prompt" ]; then
            echo "codex prompt missing" >&2
            exit 1
          fi
          attempts_run=0
          success_commit=""
          for attempt in $(seq 1 "$MAX_ATTEMPTS"); do
            attempts_run=$attempt
            echo "::group::Codex attempt $attempt"
            before=$(git rev-parse HEAD)
            set +e
            npx --yes @openai/codex exec --model codex-gpt-5 --sandbox workspace-write --full-auto - < "$prompt" 2>&1 | tee -a "$log"
            status=${PIPESTATUS[0]}
            set -e
            echo "::endgroup::"
            after=$(git rev-parse HEAD)
            git status --short > "$RUNNER_TEMP/git-status-$attempt.txt"
            printf 'attempt=%d status=%d before=%s after=%s\n' "$attempt" "$status" "$before" "$after" >> "$ATTEMPTS_LOG"
            if [ "$status" -ne 0 ]; then
              printf 'attempt=%d nonzero-status=%d\n' "$attempt" "$status" >> "$log"
            fi
            if [ "$before" != "$after" ]; then
              success_commit="$after"
              break
            fi
            if [ ! -s "$RUNNER_TEMP/git-status-$attempt.txt" ]; then
              continue
            fi
          done
          echo "attempts=$attempts_run" >> "$GITHUB_OUTPUT"
          if [ -n "$success_commit" ]; then
            echo "commit=$success_commit" >> "$GITHUB_OUTPUT"
          fi
          {
            echo "### Codex attempts"
            echo "- requested: $MAX_ATTEMPTS"
            echo "- executed: $attempts_run"
            if [ -n "$success_commit" ]; then
              echo "- commit detected: $success_commit"
            else
              echo "- commit detected: none"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Determine iteration outcome
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        id: outcome
        env:
          KEY_PRESENT: ${{ steps.key.outputs.present || 'false' }}
          PREFLIGHT_OK: ${{ steps.preflight.outputs.ok || 'false' }}
          COMMIT_SHA: ${{ steps.codex.outputs.commit }}
        run: |
          set -euo pipefail
          status="pending"
          if [ "$KEY_PRESENT" != "true" ]; then
            status="skipped_no_key"
          elif [ "$PREFLIGHT_OK" != "true" ]; then
            status="preflight_failed"
          elif [ -n "$COMMIT_SHA" ]; then
            status="commit_created"
          else
            status="completed_no_commit"
          fi
          echo "status=$status" >> "$GITHUB_OUTPUT"
          {
            echo "### Iterate outcome"
            echo "- status: $status"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build iterate diagnostics site
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        id: build_site
        env:
          STATUS: ${{ steps.outcome.outputs.status }}
          SITE_ROOT: ${{ runner.temp }}/site
          ATTEMPT_DIR: ${{ steps.prep.outputs.dir }}
          PAGES_SRC: ${{ runner.temp }}/pages-upstream
          REPO_SLUG: ${{ github.repository }}
          LOG_PATH: ${{ runner.temp }}/codex_exec.log
          ATTEMPTS_LOG: ${{ steps.prep.outputs.attempts_log }}
          PREFLIGHT_HTTP: ${{ steps.preflight.outputs.http }}
          KEY_PRESENT: ${{ steps.key.outputs.present || 'false' }}
          PREFLIGHT_OK: ${{ steps.preflight.outputs.ok || 'false' }}
          SOURCE_RUN_ID: ${{ env.SOURCE_RUN_ID }}
          SOURCE_RUN_ATTEMPT: ${{ env.SOURCE_RUN_ATTEMPT }}
          SOURCE_HEAD_BRANCH: ${{ env.SOURCE_HEAD_BRANCH }}
          SOURCE_HEAD_SHA: ${{ env.SOURCE_HEAD_SHA }}
        run: |
          set -euo pipefail
          site_dir="$SITE_ROOT"
          mkdir -p "$site_dir"
          if [ -d "$PAGES_SRC" ]; then
            cp -R "$PAGES_SRC"/. "$site_dir"/ 2>/dev/null || true
          fi
          mkdir -p "$site_dir/iterate"
          iter_page="$site_dir/iterate/${SOURCE_RUN_ID}-${SOURCE_RUN_ATTEMPT}"
          mkdir -p "$iter_page"
          attempt_dir="$ATTEMPT_DIR"
          if [ -d "$attempt_dir" ]; then
            cp -R "$attempt_dir"/. "$iter_page"/ 2>/dev/null || true
          fi
          log_path="$LOG_PATH"
          touch "$log_path"
          tail -n 20 "$log_path" > "$iter_page/codex_exec_tail.txt" || true
          attempts_log="$ATTEMPTS_LOG"
          if [ -f "$attempts_log" ]; then
            cp "$attempts_log" "$iter_page/codex_attempts.txt"
          fi
          if [ -f "$RUNNER_TEMP/preflight.status" ]; then
            cp "$RUNNER_TEMP/preflight.status" "$iter_page/preflight.status"
          fi
          if [ -f "$RUNNER_TEMP/preflight.body" ]; then
            cp "$RUNNER_TEMP/preflight.body" "$iter_page/preflight.body"
          fi
          pr_number=$(jq -r '.workflow_run.pull_requests[0].number // ""' "$GITHUB_EVENT_PATH")
          {
            printf '# Codex iterate diagnostics\n\n' > "$iter_page/index.md"
            printf -- '- Upstream run: https://github.com/%s/actions/runs/%s\n' "$REPO_SLUG" "$SOURCE_RUN_ID" >> "$iter_page/index.md"
            printf -- '- Attempt: %s\n' "$SOURCE_RUN_ATTEMPT" >> "$iter_page/index.md"
            printf -- '- Status: %s\n' "$STATUS" >> "$iter_page/index.md"
            printf -- '- OpenAI key present: %s\n' "$KEY_PRESENT" >> "$iter_page/index.md"
            printf -- '- Preflight ok: %s\n' "$PREFLIGHT_OK" >> "$iter_page/index.md"
            printf -- '- Preflight HTTP: %s\n' "${PREFLIGHT_HTTP:-n/a}" >> "$iter_page/index.md"
            printf -- '- Head branch: %s\n' "${SOURCE_HEAD_BRANCH:-unknown}" >> "$iter_page/index.md"
            printf -- '- Head SHA: %s\n' "${SOURCE_HEAD_SHA:-unknown}" >> "$iter_page/index.md"
          }
          if [ -n "$pr_number" ] && [ "$pr_number" != "null" ]; then
            printf -- '- Pull request: #%s\n' "$pr_number" >> "$iter_page/index.md"
          fi
          if [ -f "$iter_page/codex_nudge_url.txt" ]; then
            url=$(grep -m1 -E 'https?://|Diagnostics:' "$iter_page/codex_nudge_url.txt" || true)
            if [ -n "$url" ]; then
              printf -- '- Diagnostics reference: %s\n' "$url" >> "$iter_page/index.md"
            fi
          fi
          printf '\n## Codex log tail\n\n```text\n' >> "$iter_page/index.md"
          sed 's/[^[:print:]\t]/?/g' "$iter_page/codex_exec_tail.txt" >> "$iter_page/index.md"
          printf '\n```\n' >> "$iter_page/index.md"
          if [ -f "$iter_page/codex_attempts.txt" ]; then
            printf '\n## Attempt log\n\n```text\n' >> "$iter_page/index.md"
            sed 's/[^[:print:]\t]/?/g' "$iter_page/codex_attempts.txt" >> "$iter_page/index.md"
            printf '\n```\n' >> "$iter_page/index.md"
          fi
          if [ "$PREFLIGHT_OK" != "true" ] && [ -f "$iter_page/preflight.body" ]; then
            printf '\n## Preflight response body\n\n```json\n' >> "$iter_page/index.md"
            sed 's/[^[:print:]\t]/?/g' "$iter_page/preflight.body" | head -c 800 >> "$iter_page/index.md"
            printf '\n```\n' >> "$iter_page/index.md"
          fi
          idx="$site_dir/index.md"
          printf '%s\n' \
            'import os, sys, pathlib' \
            'idx_path = pathlib.Path(sys.argv[1])' \
            'run_id = os.environ.get("SOURCE_RUN_ID")' \
            'run_attempt = os.environ.get("SOURCE_RUN_ATTEMPT")' \
            'status = os.environ.get("STATUS")' \
            'repo = os.environ.get("REPO_SLUG")' \
            'link = f"iterate/{run_id}-{run_attempt}/"' \
            'lines = []' \
            'if idx_path.exists():' \
            '    lines = idx_path.read_text(encoding="utf-8").splitlines()' \
            '    lines = [ln for ln in lines if link not in ln]' \
            'else:' \
            '    lines = ["# CI Diagnostics", ""]' \
            'lines += [' \
            '    f"## Iterate attempt {run_id}/{run_attempt}",' \
            '    "",' \
            '    f"- Status: {status}",' \
            '    f"- Upstream run: https://github.com/{repo}/actions/runs/{run_id}",' \
            '    f"- Details: {link}"' \
            ']' \
            'idx_path.write_text("\\n".join(lines) + "\\n", encoding="utf-8")' | python - "$idx"
          html="$site_dir/index.html"
          printf '%s\n' \
            '<!doctype html>' \
            '<meta charset="utf-8">' \
            "<title>CI Diagnostics â€” iterate ${SOURCE_RUN_ID}</title>" \
            '<style>' \
            'body{font-family:ui-sans-serif,system-ui;margin:24px}' \
            'code,pre{font-family:ui-monospace,Consolas,monospace}' \
            '</style>' \
            '<h1>CI Diagnostics</h1>' \
            "<p><strong>Run:</strong> ${SOURCE_RUN_ID}<br><strong>Attempt:</strong> ${SOURCE_RUN_ATTEMPT}</p>" \
            '<p>See <a href="index.md">index.md</a> for a Markdown listing.</p>' > "$html"
          echo "site_dir=$site_dir" >> "$GITHUB_OUTPUT"

      - name: Upload iterate diagnostics artifact
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: iterate-diagnostics-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            $RUNNER_TEMP/codex_exec.log
            $RUNNER_TEMP/codex_attempts.txt
            $RUNNER_TEMP/preflight.json
            $RUNNER_TEMP/preflight.status
            $RUNNER_TEMP/preflight.body
            ${{ steps.prep.outputs.dir }}/codex_nudge.txt
            ${{ steps.prep.outputs.dir }}/codex_nudge_url.txt
            ${{ steps.prep.outputs.dir }}/artifacts.txt
          if-no-files-found: ignore
          retention-days: 7

      - uses: actions/configure-pages@v4
        if: ${{ github.event.workflow_run.conclusion != 'success' }}

      - name: Upload iterate Pages artifact
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        uses: actions/upload-pages-artifact@v3
        with:
          name: iterate-pages-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ steps.build_site.outputs.site_dir }}

      - name: Deploy iterate diagnostics
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Publish diagnostics URL
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        run: |
          url='${{ steps.deploy.outputs.page_url }}'
          if [ -n "$url" ]; then
            {
              echo "### Iterate diagnostics"
              echo "[$url]($url)"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Codex log tail (summary)
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        run: |
          {
            echo "### Codex log tail"
            echo '```text'
            tail -n 20 "$RUNNER_TEMP/codex_exec.log"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
