# =============================================================================
# Codex – Auto Iterate on CI Failure
# version: v2025-10-08.23   # change: fix Auth probe to use Responses API with OPENAI_MODEL
#
# Purpose:
#   Trigger when the Windows "Batch syntax/run check" workflow completes with a non-success
#   and run a headless Codex pass to propose/apply minimal changes and open/update a PR.
#
# Notes:
#   - Only change from prior working file: Auth probe now calls the Responses API using $OPENAI_MODEL.
#   - If OPENAI_API_KEY is missing, the job cleanly no-ops and uploads a skip reason.
#   - Codex runs with workspace-write + approval: never for unattended CI.
# =============================================================================

name: Codex – Auto Iterate on CI Failure

on:
  workflow_run:
    workflows: ["Batch syntax/run check"]
    types: [completed]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-iterate-${{ github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: false

env:
  ITERATOR_VERSION: v2025-10-08.23
  # Set your desired model here; example: gpt-5-codex
  OPENAI_MODEL: gpt-5-codex
  MAX_ATTEMPTS: "20"

jobs:
  iterate:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && contains(fromJson('["failure","cancelled","timed_out"]'), github.event.workflow_run.conclusion)) }}
    runs-on: ubuntu-latest

    steps:
      - name: Iterator version
        run: |
          echo "### Codex iterator" >> "$GITHUB_STEP_SUMMARY"
          echo "- version: $ITERATOR_VERSION" >> "$GITHUB_STEP_SUMMARY"
          echo "- model: $OPENAI_MODEL" >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout failing branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name }}
          fetch-depth: 0

      - name: Normalize CRLF (harmless on Linux files)
        run: |
          git config core.autocrlf true
          git config core.eol crlf

      - name: Check for OPENAI_API_KEY
        id: apikey
        shell: bash
        run: |
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip (no OPENAI_API_KEY configured)
        if: steps.apikey.outputs.present != 'true'
        shell: bash
        run: |
          echo "::notice title=Codex auto-iterate is disabled::Reason: OPENAI_API_KEY not set. Skipping."
          {
            echo "#### Auto-iterate skipped"
            echo ""
            echo "- Reason: \`OPENAI_API_KEY\` is not configured in repo **Settings → Secrets and variables → Actions**."
            echo "- Effect: No headless Codex run; your existing behavior remains unchanged."
            echo "- Iterator version: $ITERATOR_VERSION"
          } >> "$GITHUB_STEP_SUMMARY"
          printf "Codex auto-iterate skipped: missing OPENAI_API_KEY\n" > "$RUNNER_TEMP/codex_skip_reason.txt"
      - name: Upload skip reason
        if: steps.apikey.outputs.present != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: codex-skip-reason
          path: ${{ runner.temp }}/codex_skip_reason.txt
          retention-days: 7

      # -----------------------------
      # NEW: Auth probe against Responses API with OPENAI_MODEL
      # -----------------------------
      - name: Auth probe (Responses API)
        id: auth
        if: steps.apikey.outputs.present == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ env.OPENAI_MODEL }}
        shell: bash
        run: |
          set -euo pipefail
          RESP_FILE="$RUNNER_TEMP/probe.json"
          # Minimal "healthcheck" request to Responses API using OPENAI_MODEL
          PAYLOAD=$(printf '{"model":"%s","input":"healthcheck","max_output_tokens":8}' "$OPENAI_MODEL")
          HTTP=$(curl -sS -w "%{http_code}" -o "$RESP_FILE" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            https://api.openai.com/v1/responses \
            -d "$PAYLOAD")
          # Derive ok / reason
          if [ "$HTTP" = "200" ]; then
            OK=true
            REASON="ok"
          else
            OK=false
            # Extract a short error message if present
            MSG=$(jq -r '.error.message // empty' "$RESP_FILE" 2>/dev/null || true)
            REASON=${MSG:-"http_$HTTP"}
          fi
          echo "ok=$OK" >> "$GITHUB_OUTPUT"
          echo "http_code=$HTTP" >> "$GITHUB_OUTPUT"
          echo "reason=$REASON" >> "$GITHUB_OUTPUT"
          {
            echo "#### Auth probe (Responses API)"
            echo ""
            echo "- model: \`$OPENAI_MODEL\`"
            echo "- http_code: $HTTP"
            echo "- ok: $OK"
            echo "- reason: $REASON"
          } >> "$GITHUB_STEP_SUMMARY"
          # Save raw for diagnostics
          cp -f "$RESP_FILE" "$RUNNER_TEMP/auth_probe_response.json" || true

      - name: Install Codex CLI
        if: steps.apikey.outputs.present == 'true' && steps.auth.outputs.ok == 'true'
        run: npm i -g @openai/codex@latest

      - name: Git author (bot)
        if: steps.apikey.outputs.present == 'true' && steps.auth.outputs.ok == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

      - name: Loop guard
        if: steps.apikey.outputs.present == 'true' && steps.auth.outputs.ok == 'true'
        id: guard
        shell: bash
        run: |
          COUNT=$(git rev-list --all --grep='^codex: iterate on CI failure' | wc -l || true)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          if [ "$COUNT" -ge "$MAX_ATTEMPTS" ]; then
            echo "stop=true" >> "$GITHUB_OUTPUT"
            echo "Reached $MAX_ATTEMPTS attempts; exiting without changes." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "stop=false" >> "$GITHUB_OUTPUT"
            echo "next=$((COUNT+1))" >> "$GITHUB_OUTPUT"
          fi

      - name: Build prompt
        if: steps.apikey.outputs.present == 'true' && steps.auth.outputs.ok == 'true' && steps.guard.outputs.stop == 'false'
        id: prompt
        shell: bash
        run: |
          set -euo pipefail
          PROMPT="$RUNNER_TEMP/prompt.txt"
          {
            echo "Analyze the last CI failure and apply the smallest safe change set to make our Windows CI pass."
            echo ""
            echo "Constraints:"
            echo "- Keep edits minimal and targeted; no sweeping refactors."
            echo "- Preserve CRLF; keep Windows batch scripts robust."
            echo "- Update tests/docs only if behavior changes intentionally."
          } > "$PROMPT"
          echo "path=$PROMPT" >> "$GITHUB_OUTPUT"
          {
            echo ""
            echo "#### Prompt (head)"
            echo '```'
            head -n 60 "$PROMPT"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Run Codex headlessly (write-enabled, resilient)
        if: steps.apikey.outputs.present == 'true' && steps.auth.outputs.ok == 'true' && steps.guard.outputs.stop == 'false'
        id: codex
        timeout-minutes: 10
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ env.OPENAI_MODEL }}
        shell: bash
        run: |
          set -o pipefail
          LOG="$RUNNER_TEMP/codex_exec.log"
          PROMPT_PATH="${{ steps.prompt.outputs.path }}"
          BRANCH="codex/ci-fix-${{ github.event.workflow_run.head_branch || github.ref_name }}"
          echo "Target branch: $BRANCH" | tee -a "$LOG"
          tries=0
          max=3
          until [ $tries -ge $max ]; do
            tries=$((tries+1))
            echo "=== Codex attempt $tries/$max (model=$OPENAI_MODEL) ===" | tee -a "$LOG"
            codex -a never --sandbox workspace-write exec --model "$OPENAI_MODEL" "$(cat "$PROMPT_PATH")" 2>&1 | tee -a "$LOG"
            rc=${PIPESTATUS[0]}
            if [ $rc -eq 0 ]; then
              echo "codex exec exit code 0" | tee -a "$LOG"
              break
            fi
            if grep -qi 'stream error' "$LOG"; then
              echo "Detected stream error. Sleeping briefly before retry..." | tee -a "$LOG"
              sleep 6
              continue
            fi
            echo "Non-stream failure (rc=$rc). Not retrying." | tee -a "$LOG"
            break
          done
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Detect changes
        if: steps.apikey.outputs.present == 'true' && steps.auth.outputs.ok == 'true' && steps.guard.outputs.stop == 'false'
        id: diffcheck
        shell: bash
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            (git diff --staged --stat=160,999 || git diff --stat=160,999) > "$RUNNER_TEMP/diffstat.txt" || true
          fi

      - name: Clean repo temp files
        if: steps.apikey.outputs.present == 'true' && steps.auth.outputs.ok == 'true' && steps.guard.outputs.stop == 'false'
        run: |
          rm -f prompt.txt codex_nudge.txt codex_exec.log || true

      - name: Create/Update PR (commit & push inside action)
        if: steps.apikey.outputs.present == 'true' && steps.auth.outputs.ok == 'true' && steps.guard.outputs.stop == 'false' && steps.diffcheck.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token:  ${{ secrets.GITHUB_TOKEN }}
          base:   ${{ github.event.workflow_run.head_branch || github.ref_name }}
          branch: ${{ env.BRANCH }}
          title:  "Codex: iterate on CI failure – ${{ github.event.workflow_run.head_branch || github.ref_name }}"
          body:   "Automated Codex iteration.\n\n- Iterator version: ${{ env.ITERATOR_VERSION }}\n- Model: ${{ env.OPENAI_MODEL }}\n- Minimal edits; CRLF/Windows-safe."
          labels: codex,ci-fix,automerge-candidate
          commit-message: "codex: iterate on CI failure (attempt ${{ steps.guard.outputs.next }}/${{ env.MAX_ATTEMPTS }}) for ${{ github.event.workflow_run.head_branch || github.ref_name }}"

      - name: Upload Codex artifacts (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: codex-iterate-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            ${{ runner.temp }}/codex_exec.log
            ${{ runner.temp }}/auth_probe_response.json
            ${{ steps.prompt.outputs.path }}
          if-no-files-found: warn
          retention-days: 14

      - name: Summarize Codex outcome
        if: ${{ always() }}
        shell: bash
        run: |
          echo "### Codex iterate summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- iterator version: $ITERATOR_VERSION" >> "$GITHUB_STEP_SUMMARY"
          echo "- model: $OPENAI_MODEL" >> "$GITHUB_STEP_SUMMARY"
          echo "- branch: ${{ env.BRANCH || github.event.workflow_run.head_branch || github.ref_name }}" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.diffcheck.outputs.changed || 'false' }}" = "true" ]; then
            echo "- result: changes detected (PR will be created/updated)" >> "$GITHUB_STEP_SUMMARY"
            if [ -f "$RUNNER_TEMP/diffstat.txt" ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "#### Diffstat" >> "$GITHUB_STEP_SUMMARY"
              { echo '```'; cat "$RUNNER_TEMP/diffstat.txt"; echo '```'; } >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "- result: no changes produced" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -f "$RUNNER_TEMP/codex_exec.log" ]; then
            if grep -qi 'stream error' "$RUNNER_TEMP/codex_exec.log"; then
              echo "- note: stream errors occurred; a short retry was attempted" >> "$GITHUB_STEP_SUMMARY"
            fi
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "#### codex_exec.log (tail)" >> "$GITHUB_STEP_SUMMARY"
            { echo '```'; tail -n 60 "$RUNNER_TEMP/codex_exec.log" | sed 's/\x1b\[[0-9;]*m//g'; echo '```'; } >> "$GITHUB_STEP_SUMMARY"
          fi
