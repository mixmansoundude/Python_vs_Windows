# yamllint disable rule:line-length rule:truthy rule:colons rule:document-start
# version: v2025-10-06.4
# Purpose: Self-healing CI supervisor that iterates on any non-success upstream run.
# Notes:
# - Avoids status functions in expressions (always(), cancelled(), etc.).
# - Uses body-path for PR creation to avoid 21k expression limits.
# - Avoids multiline $GITHUB_ENV entirely (writes policy to a temp file and passes its path).
# Helpful refs:
# - GH expressions: https://docs.github.com/actions/learn-github-actions/expressions
# - Environment files: https://docs.github.com/actions/using-workflows/workflow-commands-for-github-actions#environment-files
# - create-pull-request: https://github.com/peter-evans/create-pull-request

name: Codex - Auto Iterate on CI Failure

on:
  workflow_run:
    workflows:
      - "Batch syntax/run check"
    types:
      - completed
  workflow_dispatch: {}
  push:
    branches:
      - '**'

permissions:
  actions: read
  contents: write
  pull-requests: write

concurrency:
  group: codex-iterate-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

jobs:
  iterate:
    # Allow manual & push. For workflow_run, only proceed if upstream wasn't success.
    if: ${{ github.event_name == 'workflow_dispatch'
            || github.event_name == 'push'
            || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success') }}
    name: Codex - Iterate
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      AGENT_POLICY_PATH: AGENTS.md
      MAIN_WORKFLOW_FILE: batch-check.yml

    steps:
      - name: Debug event
        run: |
          echo "event=${{ github.event_name }}"
          echo "ref_name=${{ github.ref_name }}"
          echo "sha=${{ github.sha }}"
          echo "actor=${{ github.actor }}"

      - name: Gather context
        id: context
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            branch="${{ github.event.workflow_run.head_branch }}"
            sha="${{ github.event.workflow_run.head_sha }}"
            actor="${{ github.event.workflow_run.actor.login }}"
            conclusion="${{ github.event.workflow_run.conclusion }}"
            run_id="${{ github.event.workflow_run.id }}"
            run_attempt="${{ github.event.workflow_run.run_attempt }}"
          else
            branch="${{ github.ref_name }}"
            sha="${{ github.sha }}"
            actor="${{ github.actor }}"
            conclusion=""
            run_id="${{ github.run_id }}"
            run_attempt="${{ github.run_attempt }}"
          fi
          if [ -z "$branch" ]; then branch="${{ github.ref_name }}"; fi
          branch_slug=$(echo "$branch" | tr ':/ ' '---')
          run_url="https://github.com/${{ github.repository }}/actions/runs/${run_id}"
          is_bot=false
          case "$actor" in
            *"[bot]"|github-actions) is_bot=true;;
          esac
          echo "branch=$branch" >> "$GITHUB_OUTPUT"
          echo "branch_slug=$branch_slug" >> "$GITHUB_OUTPUT"
          echo "head_sha=$sha" >> "$GITHUB_OUTPUT"
          echo "actor=$actor" >> "$GITHUB_OUTPUT"
          echo "is_bot=$is_bot" >> "$GITHUB_OUTPUT"
          echo "conclusion=$conclusion" >> "$GITHUB_OUTPUT"
          echo "run_id=$run_id" >> "$GITHUB_OUTPUT"
          echo "run_attempt=$run_attempt" >> "$GITHUB_OUTPUT"
          echo "run_url=$run_url" >> "$GITHUB_OUTPUT"

      - name: Prepare agent policy snippet file
        id: policy
        shell: bash
        run: |
          set -euo pipefail
          POLICY="${AGENT_POLICY_PATH:-AGENTS.md}"
          if [[ ! -f "$POLICY" ]]; then
            echo "AGENTS.md missing; falling back to CONTRIBUTING.md" >&2
            POLICY="CONTRIBUTING.md"
          fi
          OUT=".github/_AGENT_POLICY_SNIP.md"
          mkdir -p .github
          # Limit to 2000 lines to avoid giant strings.
          sed -n '1,2000p' "$POLICY" > "$OUT"
          echo "policy_path=$OUT" >> "$GITHUB_OUTPUT"

      - name: Show policy (summary)
        shell: bash
        run: |
          {
            echo "### Agent Policy (first 2000 lines)"
            echo
            echo '```markdown'
            cat ".github/_AGENT_POLICY_SNIP.md"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Poll main workflow result for this commit (push path)
        if: ${{ github.event_name != 'workflow_run' }}
        id: poll
        uses: actions/github-script@v7
        env:
          MAIN_WORKFLOW_FILE: ${{ env.MAIN_WORKFLOW_FILE }}
        with:
          script: |
            const wfFile = process.env.MAIN_WORKFLOW_FILE || 'batch-check.yml';
            const sha = context.payload.pull_request?.head?.sha || context.sha;
            const owner = context.repo.owner, repo = context.repo.repo;
            const deadline = Date.now() + 10*60*1000; // 10 min
            let run = null;
            async function findLatestForSha(){
              const { data } = await github.rest.actions.listWorkflowRuns({
                owner, repo, workflow_id: wfFile, per_page: 50
              });
              return data.workflow_runs.find(r => r.head_sha === sha) || null;
            }
            while (Date.now() < deadline) {
              run = await findLatestForSha();
              if (!run) { await new Promise(r=>setTimeout(r, 5000)); continue; }
              if (run.status === 'completed') break;
              await new Promise(r=>setTimeout(r, 10000));
            }
            core.setOutput('run_id', run?.id ? String(run.id) : '');
            core.setOutput('conclusion', run?.conclusion || '');
            core.setOutput('status', run?.status || '');

      - name: Download logs for triggering run
        if: ${{ github.event_name == 'workflow_run' || steps.poll.outputs.run_id != '' }}
        shell: bash
        env:
          RUN_ID: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.id || steps.poll.outputs.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          echo "Using RUN_ID=${RUN_ID}"
          curl -sSL -H "Authorization: Bearer $GH_TOKEN"                -o runlogs.zip                "https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/logs"
          mkdir -p runlogs
          unzip -q runlogs.zip -d runlogs || true

      - name: Download artifacts (NDJSON, diagnostics if present)
        if: ${{ github.event_name == 'workflow_run' || steps.poll.outputs.run_id != '' }}
        id: ndjson_artifacts
        shell: bash
        env:
          RUN_ID: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.id || steps.poll.outputs.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          echo "Using RUN_ID=${RUN_ID}"
          curl -sS -H "Authorization: Bearer $GH_TOKEN"             "https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/artifacts" > artifacts.json
          mkdir -p artifacts
          for prefix in ci_test_results ci-test-results test-results tests-artifacts diagnostics; do
            id=$(jq -r --arg p "$prefix" '.artifacts[] | select(.name|startswith($p)) | .id' artifacts.json | head -n 1 || true)
            if [ -n "${id:-}" ] && [ "${id:-null}" != "null" ]; then
              echo "Downloading artifact $prefix (id=$id)"
              curl -sSL -H "Authorization: Bearer $GH_TOKEN"                 -L "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$id/zip"                 -o "$prefix.zip" || true
              mkdir -p "artifacts/$prefix"
              unzip -q "$prefix.zip" -d "artifacts/$prefix" || true
            fi
          done

      - name: Get upstream run details (head sha/branch, url, name)
        if: ${{ github.event_name != 'workflow_run' && steps.poll.outputs.run_id != '' }}
        id: run_meta
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = core.getInput('run_id') || '${{ steps.poll.outputs.run_id }}';
            const { data: run } = await github.rest.actions.getWorkflowRun({ owner, repo, run_id });
            core.setOutput('head_sha', run.head_sha || '');
            core.setOutput('head_branch', run.head_branch || '');
            core.setOutput('html_url', run.html_url || '');
            core.setOutput('name', run.name || '');
        env:
          run_id: ${{ steps.poll.outputs.run_id }}

      - name: Export FAIL context
        id: failctx
        shell: bash
        run: |
          set -euo pipefail
          F_SHA="${{ github.event.workflow_run.head_sha }}"
          F_BRANCH="${{ github.event.workflow_run.head_branch }}"
          F_URL="${{ github.event.workflow_run.html_url }}"
          F_NAME="${{ github.event.workflow_run.name }}"
          [ -z "$F_SHA" ] && F_SHA="${{ steps.run_meta.outputs.head_sha }}"
          [ -z "$F_BRANCH" ] && F_BRANCH="${{ steps.run_meta.outputs.head_branch }}"
          [ -z "$F_URL" ] && F_URL="${{ steps.run_meta.outputs.html_url }}"
          [ -z "$F_NAME" ] && F_NAME="${{ steps.run_meta.outputs.name }}"
          echo "FAILED_HEAD_SHA=$F_SHA" >> $GITHUB_ENV
          echo "FAILED_HEAD_BRANCH=$F_BRANCH" >> $GITHUB_ENV
          echo "FAILED_RUN_URL=$F_URL" >> $GITHUB_ENV
          echo "FAILED_WORKFLOW_NAME=$F_NAME" >> $GITHUB_ENV
          echo "FAIL_CTX:"
          echo "  SHA=$F_SHA BRANCH=$F_BRANCH URL=$F_URL NAME=$F_NAME"

      - name: Checkout failing ref
        uses: actions/checkout@v4
        with:
          ref: ${{ env.FAILED_HEAD_SHA }}
          fetch-depth: 0

      - name: Configure git user
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Decide gate (iterate vs selfcheck)
        id: gate
        shell: bash
        env:
          WR_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          POLL_CONCLUSION: ${{ steps.poll.outputs.conclusion }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail
          should_iterate=false
          reason=""
          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            should_iterate=true
            reason="manual"
          else
            c="${WR_CONCLUSION:-${POLL_CONCLUSION:-}}"
            if [ -z "${c:-}" ] || [ "${c}" != "success" ]; then
              should_iterate=true
              reason="upstream_not_success:${c:-empty}"
            fi
          fi
          echo "should_iterate=${should_iterate}"
          echo "should_iterate=${should_iterate}" >> "$GITHUB_OUTPUT"
          echo "reason=${reason}" >> "$GITHUB_OUTPUT"

      - name: Build PR body file
        if: ${{ steps.gate.outputs.should_iterate == 'true' }}
        id: pr_body
        shell: bash
        run: |
          set -euo pipefail
          BODY_FILE=".github/ITERATE_PR_BODY.md"
          mkdir -p .github
          {
            echo "## Codex iteration"
            echo
            echo "- Upstream: ${FAILED_WORKFLOW_NAME:-} - ${FAILED_RUN_URL:-}"
            echo "- Branch: \`${FAILED_HEAD_BRANCH:-}\` @ ${FAILED_HEAD_SHA:-}"
            echo
            echo "### Agent Policy (first 2000 lines)"
            echo '```markdown'
            cat ".github/_AGENT_POLICY_SNIP.md"
            echo '```'
          } > "$BODY_FILE"
          echo "body_path=$BODY_FILE" >> "$GITHUB_OUTPUT"

      - name: Run Codex iterate (repo script if present)
        if: ${{ steps.gate.outputs.should_iterate == 'true' }}
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          if [ -x "./scripts/ci/iterate.sh" ]; then
            echo "Running repo iterate script..."
            ./scripts/ci/iterate.sh
          elif [ -x "./.github/scripts/iterate.sh" ]; then
            echo "Running .github iterate script..."
            ./.github/scripts/iterate.sh
          else
            echo "No iterate script found; creating a no-op change to force PR for visibility."
            mkdir -p .github/iterate
            date > .github/iterate/heartbeat.txt
            git add .github/iterate/heartbeat.txt || true
            git commit -m "chore(iterate): noop heartbeat to exercise PR path" || true
          fi

      - name: Create/Update PR with changes
        if: ${{ steps.gate.outputs.should_iterate == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "fix(ci): auto-iterate via Codex"
          branch: codex/auto-fix-${{ env.FAILED_HEAD_SHA }}-${{ github.run_id }}
          base: ${{ env.FAILED_HEAD_BRANCH }}
          title: "Auto-iterate via Codex"
          body-path: ${{ steps.pr_body.outputs.body_path }}

      - name: Summaries (auth/gate/report)
        if: ${{ true }}
        shell: bash
        run: |
          {
            echo "### Iterate gating"
            echo
            echo "- event: ${{ github.event_name }}"
            echo "- upstream conclusion: ${{ github.event.workflow_run.conclusion || steps.poll.outputs.conclusion || '' }}"
            echo "- should_iterate: ${{ steps.gate.outputs.should_iterate }} (reason=${{ steps.gate.outputs.reason }})"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload iterate diagnostics
        if: ${{ true }}
        uses: actions/upload-artifact@v4
        with:
          name: iterate-diagnostics
          path: |
            runlogs/**
            artifacts/**
            .github/_AGENT_POLICY_SNIP.md
            .github/ITERATE_PR_BODY.md
          if-no-files-found: ignore
