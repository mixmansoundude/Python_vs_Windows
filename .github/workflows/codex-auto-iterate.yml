# yamllint disable rule:line-length rule:truthy rule:colons rule:document-start
name: Codex – Auto Iterate on CI Failure
on:
  workflow_run:
    workflows: ["Batch syntax/run check"]   # keep this exact name
    types: [completed]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-iterate-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  iterate:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_run' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout failing branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      # Preflight: detect the API key (do not echo it)
      - name: Check for OPENAI_API_KEY
        id: apikey
        shell: bash
        run: |
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      # Keep CRLF stable (harmless even if we no-op)
      - name: Normalize CRLF
        run: |
          git config core.autocrlf true
          git config core.eol crlf

      # Try to pull the failure hint artifact produced by the Windows job.
      # Note: For PR-triggered failures, there may be NO artifact (that job posts a PR comment instead).
      - name: Download codex_nudge.txt (if present)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: codex_nudge.txt
          path: ${{ runner.temp }}

      - name: Download CI summary (if present)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: ci_test_summary.txt
          path: ${{ runner.temp }}

      - name: Download CI NDJSON (if present)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: ci_test_results.ndjson
          path: ${{ runner.temp }}

      - name: Download diagnostics URL (if present)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: codex_nudge_url.txt
          path: ${{ runner.temp }}

      - name: Determine NDJSON verdict
        id: verdict
        shell: pwsh
        run: |
          $paths = @(
            Join-Path $env:RUNNER_TEMP 'ci_test_results.ndjson/ci_test_results.ndjson'),
            'tests\~test-results.ndjson'
          )
          $target = $null
          foreach ($p in $paths) {
            if (Test-Path -LiteralPath $p) { $target = $p; break }
          }
          if (-not $target) {
            'has_failures=true' | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ascii -Append
            return
          }
          $has = $false
          foreach ($line in Get-Content -LiteralPath $target -Encoding ASCII) {
            if ([string]::IsNullOrWhiteSpace($line)) { continue }
            try {
              $row = $line | ConvertFrom-Json
            } catch {
              $has = $true
              break
            }
            if ($row.pass -eq $false) { $has = $true; break }
            if ($row.id -eq 'bootstrap.state' -and $row.details.state -notin @('ok','no_python_files')) { $has = $true; break }
          }
          $value = $has.ToString().ToLowerInvariant()
          "has_failures=$value" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ascii -Append

      # If the key is missing, loudly but cleanly skip (logs + summary + tiny artifact)
      - name: Skip (no OPENAI_API_KEY configured)
        if: steps.apikey.outputs.present != 'true'
        run: |
          echo "::notice title=Codex auto-iterate is disabled::Reason: OPENAI_API_KEY not set. Skipping headless iteration and leaving existing flow unchanged."
          {
            echo "# Codex auto-iterate skipped"
            echo ""
            echo "- **Reason:** `OPENAI_API_KEY` is not configured in repo **Settings → Secrets and variables → Actions**."
            echo "- **Effect:** No headless Codex run; existing behavior (manual Push / nudger / automerge) remains unchanged."
            echo ""
            echo "To enable: add a repository secret named **OPENAI_API_KEY** with your OpenAI API key."
          } >> "$GITHUB_STEP_SUMMARY"
          printf "Codex auto-iterate skipped: missing OPENAI_API_KEY\n" > codex_skip_reason.txt

      - name: Upload skip reason (artifact)
        if: steps.apikey.outputs.present != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: codex-skip-reason
          path: codex_skip_reason.txt
          retention-days: 7

      # Only proceed with Codex path when the key exists
      - name: Install Codex CLI
        if: steps.apikey.outputs.present == 'true' && steps.verdict.outputs.has_failures == 'true'
        run: npm i -g @openai/codex@latest

      - name: Git author
        if: steps.apikey.outputs.present == 'true' && steps.verdict.outputs.has_failures == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

      # 20-attempt guard based on our standard commit prefix
      - name: Loop guard
        if: steps.apikey.outputs.present == 'true' && steps.verdict.outputs.has_failures == 'true'
        id: guard
        shell: bash
        run: |
          BRANCH="codex/ci-fix-${{ github.event.workflow_run.head_branch }}"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          COUNT=$(git rev-list --all --grep='^codex: iterate on CI failure' | wc -l || true)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          if [ "$COUNT" -ge 20 ]; then
            echo "stop=true" >> $GITHUB_OUTPUT
            echo "Reached 20 attempts; exiting without changes."
          else
            echo "stop=false" >> $GITHUB_OUTPUT
            echo "next=$((COUNT+1))" >> $GITHUB_OUTPUT
          fi

      - name: Iterate gate debug
        if: steps.apikey.outputs.present == 'true'
        run: |
          echo "has_failures=${{ steps.verdict.outputs.has_failures }}"
          echo "apikey_present=${{ steps.apikey.outputs.present }}"
          echo "guard_stop=${{ steps.guard.outputs.stop }}"

      - name: Build prompt for Codex
        if: steps.apikey.outputs.present == 'true' && steps.guard.outputs.stop == 'false' && steps.verdict.outputs.has_failures == 'true'
        run: |
          PROMPT="$RUNNER_TEMP/prompt.txt"
          # Seed with the existing nudge or fallback
          if [ -f "$RUNNER_TEMP/codex_nudge.txt" ]; then
            BASE="$(cat "$RUNNER_TEMP/codex_nudge.txt")"
          else
            BASE="Analyze the last CI failure and apply the smallest safe change set to make our Windows CI pass."
          fi
          printf "%s\n\nPreserve CRLF; ASCII where practical; keep run_setup.bat robust; avoid sweeping refactors; minimal diagnostics only if required; write changes to files.\n" "$BASE" > "$PROMPT"

          # If we have the human-readable summary, include it verbatim
          if [ -f "$RUNNER_TEMP/ci_test_summary.txt/ci_test_summary.txt" ]; then
            {
              echo ""
              echo "----- CI Summary -----"
              head -n 300 "$RUNNER_TEMP/ci_test_summary.txt/ci_test_summary.txt"
            } >> "$PROMPT"
          fi

          # If we have the NDJSON, include the first ~40 lines for structured hints
          if [ -f "$RUNNER_TEMP/ci_test_results.ndjson/ci_test-results.ndjson" ]; then
            {
              echo ""
              echo "----- CI NDJSON (first lines) -----"
              head -n 40 "$RUNNER_TEMP/ci_test_results.ndjson/ci_test-results.ndjson"
            } >> "$PROMPT"
          fi

          if [ -f "$RUNNER_TEMP/codex_nudge_url.txt/codex_nudge_url.txt" ]; then
            {
              echo ""
              echo "Diagnostics site: $(cat "$RUNNER_TEMP/codex_nudge_url.txt/codex_nudge_url.txt")"
            } >> "$PROMPT"
          fi

          echo "PROMPT=$PROMPT" >> $GITHUB_ENV

      - name: Run Codex headlessly (gpt-4o-mini, write-enabled)
        if: steps.apikey.outputs.present == 'true' && steps.guard.outputs.stop == 'false' && steps.verdict.outputs.has_failures == 'true'
        timeout-minutes: 10
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -o pipefail
          codex -a never --sandbox workspace-write exec --model gpt-4o-mini "$(cat "$PROMPT")" 2>&1 | tee "$RUNNER_TEMP/codex_exec.log" || true

      - name: Upload Codex exec log
        if: steps.apikey.outputs.present == 'true' && steps.guard.outputs.stop == 'false' && steps.verdict.outputs.has_failures == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: codex-exec-log
          path: ${{ runner.temp }}/codex_exec.log
          retention-days: 7

      - name: Summarize Codex outcome
        if: steps.apikey.outputs.present == 'true' && steps.guard.outputs.stop == 'false' && steps.verdict.outputs.has_failures == 'true'
        run: |
          echo "## Codex iterate summary" >> "$GITHUB_STEP_SUMMARY"
          if [ -f "$RUNNER_TEMP/codex_exec.log" ]; then
            if grep -qi 'stream error' "$RUNNER_TEMP/codex_exec.log"; then
              echo "- Stream errors occurred during Codex run (see codex-exec-log)." >> "$GITHUB_STEP_SUMMARY"
            fi
            tail -n 40 "$RUNNER_TEMP/codex_exec.log" | sed 's/\x1b\[[0-9;]*m//g' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- No Codex log found." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Detect changes
        if: steps.apikey.outputs.present == 'true' && steps.guard.outputs.stop == 'false' && steps.verdict.outputs.has_failures == 'true'
        id: diffcheck
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Summarize no-op Codex run
        if: steps.apikey.outputs.present == 'true' && steps.guard.outputs.stop == 'false' && steps.diffcheck.outputs.changed == 'false' && steps.verdict.outputs.has_failures == 'true'
        run: |
          echo "::notice title=Codex iteration::Codex made no edits; see codex-exec-log artifact for details."
          {
            echo "## Codex iteration"
            echo ""
            echo "Codex made no edits; see codex-exec-log artifact for details."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Clean up repo temp files
        if: steps.apikey.outputs.present == 'true' && steps.guard.outputs.stop == 'false' && steps.verdict.outputs.has_failures == 'true'
        run: |
          rm -f prompt.txt codex_nudge.txt codex_exec.log || true

      # Let the action stage/commit/push the working tree itself.
      # This avoids the "no changes" early exit when the tree is clean.
      - name: Create/Update PR (commit & push inside action)
        if: steps.apikey.outputs.present == 'true' && steps.guard.outputs.stop == 'false' && steps.diffcheck.outputs.changed == 'true' && steps.verdict.outputs.has_failures == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token:  ${{ secrets.GITHUB_TOKEN }}
          base:   ${{ github.event.workflow_run.head_branch }}
          branch: ${{ env.BRANCH }}
          title:  "Codex: iterate on CI failure – ${{ github.event.workflow_run.head_branch }}"
          body:   "Automated Codex iteration after CI failure. Preserved CRLF/ASCII; minimal edits."
          labels: codex,ci-fix,automerge-candidate
          commit-message: "codex: iterate on CI failure (attempt ${{ steps.guard.outputs.next }}/20) for ${{ github.event.workflow_run.head_branch }}"
